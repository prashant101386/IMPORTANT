parameters:
  - name: environment
    type: string
  - name: serviceConnection
    type: string
  - name: resourceGroup
    type: string
  - name: location
    type: string
  - name: subscription
    type: string
  - name: module
    type: string
  - name: project
    type: string

jobs:

  - deployment: ${{parameters.project}}_env_deployment1
    displayName: "validation"
    environment: ${{parameters.environment}}
    strategy:
      runOnce:
        deploy:
          steps:
            - checkout: self

            - task: AzureResourceManagerTemplateDeployment@3
              name: RunPreflightValidation
              displayName: Run preflight validation
              inputs:
                connectedServiceName: ${{parameters.serviceConnection}}
                location: ${{parameters.location}}
                deploymentMode: Validation
                resourceGroupName: ${{parameters.resourceGroup}}
                csmFile: deployment/modules/${{parameters.module}}/${{parameters.module}}.bicep
                csmParametersFile: deployment/modules/${{parameters.module}}/parameters/parameters.${{parameters.environment}}.json
                overrideParameters: >
                  -subscriptionId ${{parameters.subscription}}
                  -resourceGroupName ${{parameters.resourceGroup}}
  - job: whatif
    displayName: "WhatIf"
    steps:
      - task: AzurePowerShell@5
        name: ValidateDeployment
        displayName: Validate deployment
        inputs:
          azureSubscription: ${{parameters.serviceConnection}}
          azurePowerShellVersion: LatestVersion
          ScriptType: 'InlineScript'
          Inline: |
            New-AzResourceGroupDeployment -ResourceGroupName dmw2dihtcorg01-learning -TemplateFile deployment/modules/${{parameters.module}}/${{parameters.module}}.bicep -TemplateParameterFile deployment/modules/${{parameters.module}}/parameters/parameters.${{parameters.environment}}.json -WhatIf
  - job: manual_approval
    displayName: "Manual Approval"
    dependsOn: WhatIf
    pool: server
    steps:
      - task: ManualValidation@0
        timeoutInMinutes: 60
        inputs:
          instructions: "Hi, please validate"

  - deployment: ${{parameters.project}}_env_deployment3
    displayName: "${{parameters.project}} Environment Deployment"
    dependsOn: manual_approval
    environment: ${{parameters.environment}}
    strategy:
      runOnce:
        deploy:
          steps:
            - checkout: self
            - task: AzureResourceManagerTemplateDeployment@3
              name: DeployBicepFile
              displayName: Deploy Bicep file
              inputs:
                connectedServiceName: ${{parameters.serviceConnection}}
                location: ${{parameters.location}}
                deploymentMode: Incremental
                resourceGroupName: ${{parameters.resourceGroup}}
                csmFile: deployment/modules/${{parameters.module}}/${{parameters.module}}.bicep
                csmParametersFile: deployment/modules/${{parameters.module}}/parameters/parameters.${{parameters.environment}}.json
                overrideParameters: >
                  -subscriptionId ${{parameters.subscription}}
                  -resourceGroupName ${{parameters.resourceGroup}}